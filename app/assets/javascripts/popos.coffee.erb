$(document).on 'turbolinks:load', ->
  loading = $(".placeholder-loading")

  switchViews = ->
    current = $('#view-switcher-button').text()
    if current == 'view as list'
      $('#view-switcher-button').text 'view as map'
    else
      $('#view-switcher-button').text 'view as list'
    $('#map-view').toggle()
    $('#list-view').toggle()
    return

  viewPage = (e) ->
    e.preventDefault()
    href = 'popos?page=' + extractPageNumber($(this).attr('href'))
    $.ajax(url: href).done (res) ->
      $('#list-view').html($($.parseHTML(res)).filter('#list-view').html())
      return
    return

  extractPageNumber = (address) ->
    address = address.split('page=')
    if address.length < 2
      return '1'
    else
      return address[address.length - 1]

  loading.hide()
  $(document).ajaxStart(->
    loading.show()
    return
  ).ajaxStop ->
    loading.hide()
    return

  GoogleMapsLoader.KEY = "<%= ENV['GOOGLE_KEY'] %>"
  GoogleMapsLoader.LIBRARIES = ['geometry', 'places']
  GoogleMapsLoader.load (google) ->
    mapService.initMap()
    mapService.getUserLocation()
    mapService.addPopoMarkersToMap()
    return

  $('#view-switcher-button').click(switchViews)
  $(document.body).on('click', '.pagination a', viewPage)
  return
