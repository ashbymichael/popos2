$(document).on 'turbolinks:load', ->
  loading = $(".placeholder-loading")

  switchViews = ->
    current = $('#view-switcher-button').text()
    if current == 'view as list'
      $('#view-switcher-button').text 'view as map'
    else
      $('#view-switcher-button').text 'view as list'
    $('#map-view').toggle()
    $('#list-view').toggle()
    return

  viewPage = (e) ->
    e.preventDefault()
    href = 'popos?page=' + extractPageNumber($(this).attr('href'))
    $.ajax(url: href).done (res) ->
      $('#list-view').html($($.parseHTML(res)).filter('#list-view').html())
      return
    return

  extractPageNumber = (address) ->
    address = address.split('page=')
    if address.length < 2
      return '1'
    else
      return address[address.length - 1]

  getNearby = () ->
    data = {
      'userLat': mapService.userLat
      'userLng': mapService.userLng}
    req = $.ajax(
      url: '/popos/nearby'
      method: 'post'
      data: data
      dataType: 'json')
    req.done (res) ->
      $('#list-view').html(res.html)
      mapService.hideAllMarkers()
      mapService.markNearbyOnMap(res)
      mapService.mapDiv.panTo(mapService.markers[0].getPosition())
      mapService.mapDiv.setZoom(17)
      return
    return

  loading.hide()
  $(document).ajaxStart(->
    loading.show()
    return
  ).ajaxStop ->
    loading.hide()
    return

  GoogleMapsLoader.KEY = "<%= ENV['GOOGLE_KEY'] %>"
  GoogleMapsLoader.LIBRARIES = ['geometry', 'places']
  GoogleMapsLoader.load (google) ->
    mapService.initMap()
    mapService.getUserLocation()
    mapService.addPopoMarkersToMap()
    return

  #listeners
  $('#view-switcher-button').click(switchViews)
  $('#logo').click(getNearby)
  $(document.body).on('click', '.pagination a', viewPage)
  return
